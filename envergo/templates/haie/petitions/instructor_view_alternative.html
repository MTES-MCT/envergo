{% extends "haie/petitions/instructor_view_base.html" %}

{% load moulinette %}
{% load utils %}
{% load petitions %}

{% load static %}

{% block title %}Instruction du dossier – Simulation alternative{% endblock %}

{% block project_content %}

  <div class="project-inner-content">
    <section class="fr-my-3w">
      <h2>Simulation alternative</h2>
      <p>
        Si la simulation transmise par le pétitionnaire comporte une erreur manifeste (par exemple : type de haie
        inadapté, absence de sélection des options « Proximité d’une mare » ou « Présence d’arbres à cavité »), il est
        possible de la reprendre, de la modifier et de vérifier si cela impacte les résultats obtenus.
      </p>
      <p>
        Le résultat de la simulation alternative peut être enregistré et copié-collé dans les
        <a class="fr-link"
           href="{% url 'petition_project_instructor_notes_view' petition_project.reference %}"
           {% if url_name == 'petition_project_instructor_notes_view' %}aria-current="page"{% endif %}>
        notes d’instruction</a>
        ou transmis dans un message au pétitionnaire, afin qu’il complète ou corrige sa
        demande.
      </p>
      <p>
        <a id="alternative-simulation-link"
           class="fr-btn"
           href="{{ alternative_form_url }}"
           target="_blank"
           rel="noopener external">Faire une simulation
        alternative</a>
      </p>
    </section>
  </div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    window.addEventListener('load', function () {
      const alternativeBtn = document.getElementById('alternative-simulation-link');
      alternativeBtn.addEventListener('click', function (evt) {
        // Block the navigation for sending an analytics event before
        evt.preventDefault();
        const href = alternativeBtn.href;

        let url = EVENTS_URL;
        let token = CSRF_TOKEN;
        let headers = {"X-CSRFToken": token};
        let data = new FormData();
        data.append("category", "projet");
        data.append("action", "simulation_alt");
        data.append("metadata", JSON.stringify({
          "reference": "{{ petition_project.reference }}"
        }));
        fetch(url, {
          headers: headers, body: data, method: 'POST'
        }).catch(error => {
          console.warn('Tracking failed:', error);
          // We still want to navigate even on failure
        }).finally(() => {
          // Proceed with navigation manually
          window.open(href, '_blank');
        });
      });
    });
  </script>
{% endblock %}
