{% extends "base.html" %}

{% load static %}

{% block title %}Instruction du dossier{% endblock %}

{% block container %}
  <section class="fr-py-8w alt">
    <div class="fr-container">
      <div class="fr-grid-row">
        <div class="fr-col-6 fr-col-offset-3">
          <span class="fr-h1">Dossier n° {{ petition_project.demarches_simplifiees_dossier_number }}</span>
        </div>
        <div class="fr-col-3">
          <ul class="fr-btns-group fr-btns-group--icon-right">
            <li>
              <a class="fr-btn fr-btn--icon-right fr-icon-external-link-line"
                 title="Dossier dans Démarches Simplifiées"
                 href="https://www.demarches-simplifiees.fr/procedures/{{ project_details.demarche_simplifiee_number }}/dossiers/{{ project_details.demarches_simplifiees_dossier_number }}"
                 target="_blank"
                 rel="noopener external">Consulter le dossier</a>
            </li>
            <li>
              <a class="fr-btn  fr-btn--secondary fr-btn--icon-right fr-icon-mail-line"
                 title="Dossier dans Démarches Simplifiées"
                 href="https://www.demarches-simplifiees.fr/procedures/{{ project_details.demarche_simplifiee_number }}/dossiers/{{ project_details.demarches_simplifiees_dossier_number }}/messagerie"
                 target="_blank"
                 rel="noopener external">Contacter le pétitionnaire</a>
            </li>
            <li>
              <a class="fr-btn  fr-btn--secondary fr-btn--icon-right fr-icon-download-line"
                 title="Dossier dans Démarches Simplifiées"
                 href="{% url 'petition_project_hedge_data_export' petition_project.reference %}">Télécharger le tracé des haies</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

  </section>
  <section class="fr-py-8w">
    <div class="fr-container">
      <div class="fr-grid-row">
        <div class="fr-col fr-col-3">
          <nav class="fr-sidemenu" aria-labelledby="fr-sidemenu-title">
            <div class="fr-sidemenu__inner">
              <div id="fr-sidemenu-wrapper">
                <ul class="fr-sidemenu__list">
                  <li class="fr-sidemenu__item fr-sidemenu__item--active">
                    <a class="fr-sidemenu__link"
                       href="#project-specifications"
                       target="_self"
                       aria-current="page">Caractéristiques du projet</a>
                  </li>
                  {% for information in project_details.details %}
                    {% if information.slug %}
                      <li class="fr-sidemenu__item">
                        <a class="fr-sidemenu__link"
                           href="#{{ information.slug }}"
                           target="_self">{{ information.label }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>
          </nav>
        </div>
        <div id="project-specifications" class="fr-col">
          <h1>Caractéristiques du projet</h1>
          {% for information in project_details.details %}
            <section class="fr-mt-6w"
                     {% if information.slug %}id="{{ information.slug }}"{% endif %}>
              {% if information.label %}<h2 class="fr-mb-0">{{ information.label }}</h2>{% endif %}
              <p class="fr-hint-text">
                {% if information.comment %}{{ information.comment }}{% endif %}
              </p>
              {% include "haie/petitions/_items.html" with items=information.items %}
              {% if information.details %}
                {% for information_details in information.details %}
                  <h3 class="fr-mt-4w">{{ information_details.label }}</h3>

                  {% include "haie/petitions/_items.html" with items=information_details.items %}

                {% endfor %}
              {% endif %}
              {% if forloop.first %}
                <button class="hedge-input-open-btn fr-btn fr-btn--secondary fr-btn--icon-right fr-icon-arrow-right-line fr-mt-2w"
                        type="button"
                        data-fr-opened="false"
                        aria-controls="hedge-input-modal">Voir le tracé des haies sur la carte</button>
              {% endif %}
            </section>
          {% endfor %}
        </div>
      </div>
    </div>

  </section>

  {% include 'haie/moulinette/_hedge_input_modal.html' %}
{% endblock %}

{% block extra_js %}
  <script>var HEDGES_PLANTATION_URL = "{% url 'input_hedges'  mode='read_only' %}";</script>
  <script>var HEDGE_DATA_ID = "{{ moulinette.catalog.haies.id }}";</script>
  <script>var SOURCE_PAGE = "instruction";</script>
  <script defer src="{% static 'js/libs/hedges_input.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var forms = document.querySelectorAll('form');
      var beforeUnloadListenerAdded = false;

      function preventLeaving(e) {
        e.preventDefault();
        var confirmationMessage = 'Vous avez des modifications non enregistrées. Êtes-vous sûr de vouloir quitter la page ?';
        e.returnValue = confirmationMessage; // Standard for most browsers
        return confirmationMessage; // For some older browsers
      }

      forms.forEach(function (form) {
        form.addEventListener('change', function () {
          if (!beforeUnloadListenerAdded) {
            window.addEventListener('beforeunload', preventLeaving);
            beforeUnloadListenerAdded = true;
          }
        });

        form.addEventListener('submit', function () {
          if(beforeUnloadListenerAdded){
            window.removeEventListener('beforeunload', preventLeaving);
            beforeUnloadListenerAdded = false;
          }
        });
      });
    });
  </script>
{% endblock %}
