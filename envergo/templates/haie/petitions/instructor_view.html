{% extends "haie/petitions/instructor_view_base.html" %}

{% load evaluations %}
{% load moulinette %}
{% load utils %}
{% load petitions %}
{% load static %}

{% block title %}Instruction du dossier – Résumé du dossier{% endblock %}

{% block project_view_title %}<h1>Résumé du dossier</h1>{% endblock %}

{% block project_content %}

  <div class="project-inner-content">

    {% include 'haie/moulinette/_department_doctrine_button.html' with config=moulinette.config %}

    {% if has_hedges_outside_department %}
      <div class="fr-alert fr-alert--warning fr-mb-4w">
        <h3 class="fr-alert__title">Le projet est hors du département sélectionné</h3>
        <p>
          Au moins un des linéaires saisis est situé hors du département choisi pour la simulation réalisée par le demandeur – {{ config.department }}.
        </p>
        <p>
          Le simulateur n’est pas paramétré pour gérer les règles combinées de plusieurs départements.
          L’instruction de la demande et l'élaboration de la décision unique peuvent nécessiter de se coordonner avec les services des préfectures concernées.
        </p>
        <p>
          Le demandeur a été averti en ce sens (voir <a href="{% url 'petition_project' petition_project.reference %}">le résultat de la simulation</a>) avant qu'il dépose sa demande.
        </p>
      </div>
    {% endif %}

    <section id="section-key-elements" class="fr-my-4w">
      <div class="title-with-link-container">
        <h2 class="fr-mr-8w">Informations saisies par le demandeur</h2>
        <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right fr-mb-3w"
           href="{% url 'petition_project_instructor_dossier_complet_view' petition_project.reference %}">Voir le dossier
        complet</a>
      </div>

      <p>
        <span><b>Motif de la destruction :</b></span> <span>{% humanize_motif motif %}</span>
      </p>

      <h6>Linéaires</h6>

      <div class="fr-my-3w">
        <button class="hedge-input-open-btn fr-btn  fr-btn--secondary fr-btn--icon-left fr-icon-haie"
                type="button"
                data-fr-opened="false"
                aria-controls="hedge-input-modal">Ouvrir la carte des haies</button>
      </div>

      <ul class="instructor-view-list fr-mb-3w">
        {% include "haie/petitions/_item.html" with label="Total linéaire à détruire" value=length_to_remove|floatformat:"0g" unit="m" %}
        {% include "haie/petitions/_item.html" with label="Mode de destruction" %}
        {% for mode, hedges_by_mode in hedge_to_remove_by_destruction_mode.items %}
          <li class="fr-pl-4w">
            <span>{{ hedges_by_mode.label }} :</span>
            <span>{{ hedges_by_mode.length|floatformat:"0g" }} m
              {% if hedges_by_mode %}• {{ hedges_by_mode.names }}{% endif %}
            </span>
          </li>
        {% endfor %}
      </ul>

      {% if hedge_to_plant_by_plantation_mode %}
        <ul class="instructor-view-list fr-mb-3w">
          {% include "haie/petitions/_item.html" with label="Total linéaire à planter, renforcer ou reconnecter" value=length_to_plant|floatformat:"0g" unit="m" %}
          {% for mode, hedges_by_mode in hedge_to_plant_by_plantation_mode.items %}
            <li class="fr-pl-4w">
              <span>{{ hedges_by_mode.label }} :</span>
              <span>{{ hedges_by_mode.length|floatformat:"0g" }} m
                {% if hedges_by_mode %}• {{ hedges_by_mode.names }}{% endif %}
              </span>
            </li>
          {% endfor %}
          {% include "haie/petitions/_item.html" with label="Ratio de replantation, renforcement ou reconnexion" value=plantation_ratio|floatformat:"2g" comment="Linéaire total à planter, renforcer ou reconnecter / linéaire à détruire" %}
          {% include "haie/petitions/_item.html" with label="Ratio de replantation uniquement" value=plantation_ratio|floatformat:"2g" comment="Linéaire plantation nouvelle ou remplacement / linéaire à détruire" %}
        </ul>
      {% else %}
        {{ hedge_to_plant_by_plantation_mode }}
        <ul class="instructor-view-list fr-mb-3w">
          {% include "haie/petitions/_item.html" with label="Total linéaire à planter" value=length_to_plant|floatformat:"0g" unit="m" %}
          {% include "haie/petitions/_item.html" with label="Ratio de replantation" value=plantation_ratio|floatformat:"2g" %}
        </ul>
      {% endif %}

      {% include 'hedges/_hedge_summary_table.html' with hedges=haies.hedges %}

    </section>

    <section id="section-moulinette-result" class="fr-my-4w">
      <div class="title-with-link-container">
        <h2 class="fr-mr-8w">Réponse du simulateur</h2>
        <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right fr-mb-3w"
           href="{% url 'petition_project' petition_project.reference %}">Voir la réponse complète</a>
      </div>
      <h3 class="fr-sr-only">Réglementations</h3>
      <p class="fr-mb-4w">
        <em>Avant de déposer son dossier et de remplir le formulaire complet,
          le demandeur a réalisé une simulation en localisant et décrivant les haies à détruire.
        Voici la réponse du simulateur sur les réglementations concernant le projet&nbsp;:</em>
      </p>
      <div class="fr-container--fluid fr-ml-5w">
        {% for regulation in moulinette.regulations|dictsort:"display_order" %}
          <div class="fr-mb-3w">
            <a class="fr-link fr-icon-arrow-right-line fr-link--icon-right"
               href="{% url 'petition_project_instructor_regulation_view' petition_project.reference regulation.slug %}">
              <div class="fr-grid-row">
                <h4 class="fr-h5 fr-col-12 fr-col-sm-7 fr-col-md-12 fr-col-lg-7 fr-mb-1v">{{ regulation.title }}</h4>
                <span class="fr-col-12 fr-col-sm-5 fr-col-md-12 fr-col-lg-5">{% result_tag regulation.result regulation.result_tag_style %}</span>
              </div>
              <span>Aller au détail</span>
            </a>
          </div>
        {% endfor %}
      </div>
    </section>
    <section id="section-plantation-evaluation" class="fr-my-4w fr-ml-5w">
      <h3 class="fr-h4 fr-mt-4w">Acceptabilité de la plantation</h3>
      <p class="fr-mb-3w">
        <em>Dans la simulation, le demandeur a également localisé et décrit les haies à planter en compensation de la destruction.
        Le simulateur vérifie une liste de conditions d'acceptabilité de la plantation. Voici ce qui a été affiché :</em>
      </p>
      {% if plantation_evaluation.result == "adequate" %}
        <div class="fr-alert fr-alert--success fr-mb-3w">
          <h4 class="fr-alert__title">La plantation envisagée est adéquate</h4>
          <p>Le projet de plantation apparaît acceptable au regard des haies détruites.</p>
        </div>
      {% else %}
        <div class="fr-alert fr-alert--error fr-mb-3w">
          <h4 class="fr-alert__title">La plantation envisagée n'est pas adéquate</h4>
          <p>Le projet de plantation décrit n'apparaît pas acceptable au regard des haies détruites.</p>
        </div>
      {% endif %}

      {% include 'haie/moulinette/_plantation_conditions.html' %}
    </section>

  </div>
{% endblock %}

{% block extra_body %}
  {{ block.super }}
  {% include 'haie/moulinette/_department_doctrine_modal.html' with config=moulinette.config %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script defer src="{% static 'js/libs/form_project_instruction.js' %}"></script>
{% endblock %}
