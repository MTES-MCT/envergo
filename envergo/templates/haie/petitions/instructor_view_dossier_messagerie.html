{% extends "haie/petitions/instructor_view_base.html" %}

{% load utils petitions %}

{% block title %}Instruction du dossier – Messagerie{% endblock %}

{% block project_view_title %}<h2>Messagerie</h2>{% endblock %}

{% block project_content %}

  <div class="dj-message fr-alert fr-alert--info">
    <h3 class="fr-alert__title">Cette page est en cours de construction.</h3>
    <p>
      En attendant, vous pouvez échanger avec le pétitionnaire via Démarches Simplifiées
      <a href="{{ ds_url }}messagerie" target="_blank" rel="noopener external">en cliquant sur ce lien</a>.
    </p>
  </div>

  <section class="ds-messages fr-my-4w">
    <h4>Envoyer un message</h4>
    <form method="post"
          action="{% url 'petition_project_instructor_messagerie_view' petition_project.reference %}">
      {% csrf_token %}

      <div id="field-message_body" class="fr-my-2w">
        {% include '_field_snippet.html' with field=form.message_body %}
        <button type="submit"
                class="fr-btn fr-btn--primary"
                formaction="{% url 'petition_project_instructor_messagerie_view' petition_project.reference %}">
          Envoyer le message
        </button>
      </div>
    </form>
  </section>

  {% if ds_messages is not None %}
    <section class="ds-messages fr-my-4w">
      <p class="fr-mb-1w">
        {% with num_messages=ds_messages|length num_messages_displayed=20 %}
          {% if num_messages <= num_messages_displayed %}
            {{ num_messages }} message{{ num_messages|pluralize }}
          {% else %}
            {{ num_messages_displayed }} messages affichés sur {{ num_messages }} messages
          {% endif %}
        {% endwith %}
      </p>

      {% for message in ds_messages|slice:":num_messages_displayed" %}
        <div class="ds-message ds-message--{% ds_sender_category message.email ds_sender_emails_categories %} fr-mb-3w fr-p-3w">
          <div class="fr-mb-2w ds-message__metadata">
            <span class="ds-message__exp">{{ message.email }}</span> –
            {% with message_date=message.createdAt|to_datetime %}
              <span class="ds-message__date">{{ message_date|date:"D\. j F Y" }} {{ message_date|time:"H\hi" }}</span>
            {% endwith %}
          </div>
          <div class="ds-message__content">{{ message.body|safe|linebreaksbr }}</div>

          <div class="fr-mt-2w">
            {% for pj in message.attachments %}
              <div class="fr-download">
                <a class="fr-link ds-message__pj" target="_blank" href="{{ pj.url }}">
                  <span class="fr-sr-only">Télécharger le fichier</span>
                  {{ pj.filename }}
                  <span class="fr-download__detail">{{ pj.contentType }} – {{ pj.byteSize|filesizeformat }}</span>
                </a>
              </div>
            {% endfor %}

          </div>
        </div>
      {% endfor %}
    </section>
  {% endif %}

{% endblock %}
