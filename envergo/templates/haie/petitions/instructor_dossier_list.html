{% extends 'haie/base.html' %}

{% load petitions %}

{% load static %}

{% block title %}
  Liste des dossiers
{% endblock title %}

{% block content %}
  <h1 class="fr-my-4w project-list__title">Tous les dossiers</h1>
  {% with project_number=page_obj.paginator.count %}
    {% if project_number <= 0 %}
      <div class="fr-alert fr-alert--info">
        <h3 class="fr-alert__title">Aucun dossier n’est accessible pour le moment</h3>
        <p>Vous n’avez actuellement accès à aucun dossier.</p>
        <p>
          Pour accéder à un dossier spécifique, vous devez être invité par un instructeur et cliquer sur le lien
          d’invitation qu’il vous a transmis.
        </p>
        <p>
          Si vous attendez des droits d’accès à l’ensemble d’un département, leur attribution peut prendre jusqu’à 24
          heures après la création de votre compte.
          En cas de difficulté, vous pouvez contacter
          <a href="{% url 'contact_us' %}">l’équipe du Guichet unique de la haie.</a>
        </p>
      </div>
    {% endif %}

    <div class="fr-table--lg fr-table project-list__table">
      <div class="fr-table__wrapper">
        <div class="fr-table__container">
          <div class="fr-table__content">
            <table id="table-dossier-list">
              <caption class="fr-mt-1w fr-mb-0">
                {{ project_number }}
                dossier{{ project_number|pluralize }}
              </caption>
              <thead>
                <tr>
                  <th scope="col">
                    N° dossier
                    <br />
                    Date de dépôt
                  </th>
                  <th scope="col">Étape</th>
                  <th scope="col">
                    Demandeur
                    <br />
                    Commune
                  </th>
                  <th scope="col">
                    Linéaire
                    <br />
                    à détruire
                  </th>
                  <th scope="col">Décision</th>
                  <th scope="col">Suivi</th>
                </tr>
              </thead>
              <tbody>
                {% for project in object_list %}

                  <tr class="project">
                    <td>
                      <a href="{% url 'petition_project_instructor_view' project.reference %}"
                         class="fr-link">{{ project.demarches_simplifiees_dossier_number|format_ds_number }}</a>
                      <br />
                      {{ project.prefetched_dossier.date_depot|date:"SHORT_DATE_FORMAT" }}
                    </td>
                    <td>{{ project.current_stage|stage_badge }}</td>
                    <td>
                      {% if project.organization %}
                        {{ project.organization }}
                      {% else %}
                        {{ project.prefetched_dossier.applicant_name }}
                      {% endif %}
                      <br />
                      {{ project.city }}
                    </td>
                    <td>{{ project.hedge_data.length_to_remove|floatformat:"0g" }}&nbsp;m</td>
                    <td>{{ project.current_decision|decision_badge }}</td>
                    <td>
                      {% include 'haie/petitions/_follow_form.html' with reference=project.reference followed_up=project.followed_up %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
      {% if page_obj.paginator.num_pages > 1 %}
        <div class="fr-table__footer">
          <div class="fr-table__footer--middle fr-mt-0">{% include "_pagination.html" with page_obj=page_obj %}</div>
        </div>
      {% endif %}
    </div>
  {% endwith %}

{% endblock %}
{% block extra_js %}
  <script defer src="{% static 'js/libs/follow_up_form.js' %}"></script>
  <script>
    window.addEventListener('load', function () {
      document.querySelectorAll("#table-dossier-list tbody tr").forEach(row => {
        const link = row.querySelector("td:first-child a");
        if (!link) return;

        row.addEventListener("click", (e) => {
          // Prevent row click if user clicked another link or a button
          if (e.target.closest("a, button, input, textarea, select")) return;
          window.location.href = link.href;
        });

        row.style.cursor = "pointer";
      });
    });
  </script>
{% endblock %}
