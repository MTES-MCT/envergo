{% extends "haie/petitions/instructor_view_base.html" %}

{% load moulinette %}
{% load utils %}
{% load petitions %}

{% load static %}

{% block title %}Instruction du dossier – Notes pour l'instructeur{% endblock %}

{% block project_content %}

  <div class="project-inner-content">

    {% include 'haie/moulinette/_department_doctrine_button.html' with config=moulinette.config %}

    <form method="post"
          action="{% url 'petition_project_instructor_view' petition_project.reference %}">
      {% csrf_token %}

      <section class="fr-my-3w" id="instructor_free_mention">
        <h2>Notes libres pour l'instruction</h2>
        <div id="field-instructor_free_mention" class="fr-my-2w">
          {% include '_field_snippet.html' with field=form.instructor_free_mention %}
          <button type="submit"
                  class="fr-btn fr-btn--secondary"
                  formaction="{% url 'petition_project_instructor_view' petition_project.reference %}#field-instructor_free_mention">
            Enregistrer
          </button>
        </div>
      </section>
    </form>

  </div>
{% endblock %}

{% block extra_body %}
  {% include 'haie/moulinette/_department_doctrine_modal.html' with config=moulinette.config %}
{% endblock %}

{% block extra_js %}
  <script>var HEDGES_PLANTATION_URL = "{{ plantation_url|safe }}";</script>
  <script>var SOURCE_PAGE = "instruction";</script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var forms = document.querySelectorAll('form');
      var beforeUnloadListenerAdded = false;

      function preventLeaving(e) {
        e.preventDefault();
        var confirmationMessage = 'Vous avez des modifications non enregistrées. Êtes-vous sûr de vouloir quitter la page ?';
        e.returnValue = confirmationMessage; // Standard for most browsers
        return confirmationMessage; // For some older browsers
      }

      forms.forEach(function (form) {
        form.addEventListener('change', function () {
          if (!beforeUnloadListenerAdded) {
            window.addEventListener('beforeunload', preventLeaving);
            beforeUnloadListenerAdded = true;
          }
        });

        form.addEventListener('submit', function () {
          if(beforeUnloadListenerAdded){
            window.removeEventListener('beforeunload', preventLeaving);
            beforeUnloadListenerAdded = false;
          }
        });
      });
    });
  </script>
{% endblock %}
