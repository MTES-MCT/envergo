{% extends "haie/petitions/instructor_view_base.html" %}

{% load moulinette %}
{% load utils %}
{% load petitions %}

{% load static %}

{% block title %}Instruction du dossier – Procédure{% endblock %}

{% block project_view_title %}<h2>Procédure</h2>{% endblock %}

{% block project_content %}
  <div>
    <h3>État du dossier</h3>
  </div>
  <div class="project-inner-content">
    <section class="fr-my-3w">
      <h4>Étape</h4>
      <p>{% stage_badge petition_project.current_stage False %}</p>
      <p id="due-date-container">
        <b>Échéance d'instruction :</b>
        <br />
        {{ petition_project.due_date|display_due_date }}

        {% include "haie/petitions/stage_objectives/"|add:petition_project.current_stage|add:".html" %}

      </p>

      <h4>Décision</h4>
      <p>{% decision_badge petition_project.current_decision False False %}</p>
    </section>
  </div>
  {% if is_department_instructor %}
    <button class="fr-btn"
            {% if petition_project.demarches_simplifiees_state == "draft" %}disabled{% endif %}
            data-fr-opened="{% if form.errors %}true{% else %}false{% endif %}"
            aria-controls="procedure-modal">Modifier</button>
    {% if petition_project.demarches_simplifiees_state == "draft" %}
      <span class="fr-hint-text">Ce dossier n'a pas encore été déposé par le pétitionnaire.</span>
    {% endif %}
  {% endif %}

  {% if paginator.count %}
    <h3 class="fr-mt-6w">Historique des changements</h3>
    <div class="fr-table  procedure-history__table">
      <div class="fr-table__wrapper">
        <div class="fr-table__container">
          <div class="fr-table__content">
            <table>
              <caption class="fr-mt-1w fr-mb-0">
                {{ paginator.count }}
                changement{{ paginator.count|pluralize }}
              </caption>
              <thead>
                <tr>
                  <th scope="col">Date / heure de la saisie</th>
                  <th scope="col">Date effective</th>
                  <th scope="col">Auteur</th>
                  <th scope="col">Étape / Décision départ</th>
                  <th scope="col">Étape / Décision arrivée</th>
                  <th scope="col">Commentaire</th>
                </tr>
              </thead>
              <tbody>
                {% for log in object_list %}
                  <tr class="project">
                    <td>{{ log.created_at|date:"SHORT_DATETIME_FORMAT" }}</td>
                    <td>{{ log.status_date|date:"SHORT_DATE_FORMAT" }}</td>
                    <td>
                      <span class="described-by-tooltip"
                            aria-describedby="email-tooltip-{{ forloop.counter }}">{{ log.created_by.email }}</span>
                      <span class="fr-tooltip fr-placement"
                            role="tooltip"
                            id="email-tooltip-{{ forloop.counter }}">{{ log.created_by.email }}</span>
                    </td>
                    <td>
                      {% if log.previous_log %}
                        {{ log.previous_log.get_stage_display }}
                        {% if log.previous_log.decision != "unset" %}
                          <br />
                          {{ log.previous_log.get_decision_display }}
                        {% endif %}
                      {% else %}
                        {{ log|choice_default_label:"stage" }}
                      {% endif %}
                    </td>
                    <td>
                      {{ log.get_stage_display }}
                      {% if log.decision != "unset" %}
                        <br />
                        {{ log.get_decision_display }}
                      {% endif %}
                    </td>
                    <td>
                      <span class="described-by-tooltip"
                            aria-describedby="comment-tooltip-{{ forloop.counter }}">{{ log.update_comment }}</span>
                      <span class="fr-tooltip fr-placement"
                            role="tooltip"
                            id="comment-tooltip-{{ forloop.counter }}">{{ log.update_comment }}</span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
      {% if page_obj.paginator.num_pages > 1 %}
        <div class="fr-table__footer">
          <div class="fr-table__footer--middle fr-mt-0">{% include "_pagination.html" with page_obj=page_obj %}</div>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_body %}
  {{ block.super }}
  {% include 'haie/petitions/_procedure_modal.html' %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    window.addEventListener('load', function () {
      const displayStageObjective = (stage) => {
        document.querySelectorAll(".stage-objective").forEach(div => div.style.display = "none");
        document.getElementById(`stage-objective--${stage}`).style.display = "block";
      };

      document.getElementById("id_stage").addEventListener("change", function (event) {
        displayStageObjective(event.target.value);
      });
      displayStageObjective(document.getElementById("id_stage").value);

    });
  </script>
{% endblock %}
