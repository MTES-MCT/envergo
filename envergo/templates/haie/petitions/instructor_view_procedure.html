{% extends "haie/petitions/instructor_view_base.html" %}

{% load moulinette %}
{% load utils %}
{% load petitions %}

{% load static %}

{% block title %}Instruction du dossier – Procédure{% endblock %}

{% block project_view_title %}<h2>Procédure</h2>{% endblock %}

{% block project_content %}
  <div>
    <h3>État du dossier</h3>
  </div>
  <div class="project-inner-content{{ petition_project.is_paused|yesno:" paused," }}">
    <section class="fr-my-3w">
      <h4>Étape</h4>
      <p>{% stage_badge petition_project.current_stage False %}</p>

      <div id="due-date-container" class="fr-mb-3w">

        {% if petition_project.is_paused %}
          <div class="alt-light fr-py-3w fr-px-3w fr-mb-3w">
            <b>En attente de compléments</b>
            <br />
            {% display_due_date petition_project.due_date %}

            {% if resume_processing_form %}
              <div class="fr-mt-1w">
                <button type="button"
                        class="fr-btn fr-btn--primary hide-expanded"
                        aria-expanded="false"
                        aria-controls="resume-form">Reprendre l'instruction</button>
              </div>

              <div id="resume-form" class="fr-collapse">
                <h4 class="fr-mt-2w">→ Reprendre l'instruction</h4>

                <form method="post"
                      action="{% url 'petition_project_instructor_request_info_view' petition_project.reference %}"
                      class="fr-mt-1w">
                  {% csrf_token %}
                  {% include '_form_snippet.html' with form=resume_processing_form %}

                  {% if petition_project.current_status.original_due_date %}
                    <div class="fr-input-group">
                      <label for="" class="fr-label">
                        <span class="label-content fr-text--bold">Nouvelle échéance d'instruction</span>
                        <span class="fr-text--light fr-text--sm">(calcul automatique)</span>
                      </label>

                      <input id="id_new_due_date"
                             type="date"
                             disabled="disabled"
                             class="fr-input"
                             data-suspension-date="{{ petition_project.current_status.suspension_date|date:"c" }}"
                             data-original-due-date="{{ petition_project.current_status.original_due_date|date:"c" }}">
                    </div>
                  {% endif %}

                  <button type="button"
                          class="fr-btn fr-btn--secondary"
                          aria-expanded="false"
                          aria-controls="resume-form">Annuler</button>

                  <button type="submit" class="fr-btn fr-btn--primary">Reprendre l'instruction</button>
                </form>
              </div>
            {% endif %}

          </div>

          <p>
            <strong>Date de la suspension</strong>
            <br />
            <span class="due-date fr-text--sm">
              <span class="fr-icon-pause-circle-line fr-icon--sm"></span>
              {{ petition_project.current_status.suspension_date|date:"DATE_FORMAT" }}
            </span>
          </p>

          {% if petition_project.current_status.original_due_date %}
            <p>
              <strong>Échéance d'instruction avant la suspension</strong>
              <br />
              <span class="due-date fr-text--sm">
                <span class="fr-icon-timer-line fr-icon--sm"></span>
                {{ petition_project.current_status.original_due_date|date:"DATE_FORMAT" }}
              </span>
            </p>
          {% endif %}

        {% else %}

          {% if petition_project.current_stage != "closed" %}
            <b>Échéance pour cette étape :</b>
            <br />
            {% display_due_date petition_project.due_date %}
          {% endif %}
        {% endif %}

        {% include "haie/petitions/stage_objectives/"|add:petition_project.current_stage|add:".html" %}
      </div>

      {% if is_department_instructor and not request_info_form and not petition_project.is_paused %}
        <button type="button"
                class="fr-btn fr-btn--secondary fr-mb-3w disabled"
                disabled="disabled"
                aria-describedby="disabled-rai-btn-tooltip">Demander des compléments</button>
        <span class="fr-tooltip fr-placement"
              id="disabled-rai-btn-tooltip"
              role="tooltip">Disponible uniquement pendant les étapes d'instruction.</span>

      {% endif %}

      {% if request_info_form and not petition_project.is_paused %}
        <button type="button"
                class="fr-btn fr-btn--secondary fr-mb-3w hide-expanded"
                aria-expanded="false"
                aria-controls="rai-date-form">Demander des compléments</button>

        <div id="rai-date-form" class="fr-collapse">
          <div class="alt fr-py-3w fr-px-3w fr-mt-2w fr-mb-3w">
            <h4>Demander des compléments</h4>

            <p>La demande de compléments suspendra le délai d'instruction.</p>

            <form method="post"
                  action="{% url 'petition_project_instructor_request_info_view' petition_project.reference %}">
              {% csrf_token %}

              {% include '_form_snippet.html' with form=request_info_form %}

              <button type="button"
                      class="fr-btn fr-btn--secondary"
                      aria-expanded="false"
                      aria-controls="rai-date-form">Annuler</button>

              <button type="submit" class="fr-btn fr-btn--primary">Envoyer au demandeur</button>

            </form>
          </div>
        </div>
      {% endif %}

      <h4>Décision</h4>
      <p>{% decision_badge petition_project.current_decision False %}</p>
    </section>
  </div>
  {% if is_department_instructor %}
    <button class="fr-btn"
            {% if petition_project.demarches_simplifiees_state == "draft" %}disabled{% endif %}
            data-fr-opened="{% if form.errors %}true{% else %}false{% endif %}"
            aria-controls="procedure-modal">Modifier l'état du dossier</button>
    {% if petition_project.demarches_simplifiees_state == "draft" %}
      <span class="fr-hint-text">Ce dossier n'a pas encore été déposé par le pétitionnaire.</span>
    {% endif %}
  {% endif %}

  {% if paginator.count %}
    <h3 class="fr-mt-6w">Historique des changements</h3>
    <div class="fr-table  procedure-history__table">
      <div class="fr-table__wrapper">
        <div class="fr-table__container">
          <div class="fr-table__content">
            <table>
              <caption class="fr-mt-1w fr-mb-0">
                {{ paginator.count }}
                changement{{ paginator.count|pluralize }}
              </caption>
              <thead>
                <tr>
                  <th scope="col">Date / heure de la saisie</th>
                  <th scope="col">Date effective</th>
                  <th scope="col">Auteur</th>
                  <th scope="col">Étape / Décision départ</th>
                  <th scope="col">Étape / Décision arrivée</th>
                  <th scope="col">Commentaire</th>
                </tr>
              </thead>
              <tbody>
                {% for log in object_list %}
                  <tr class="project">
                    <td>{{ log.created_at|date:"SHORT_DATETIME_FORMAT" }}</td>
                    <td>{{ log.status_date|date:"SHORT_DATE_FORMAT" }}</td>
                    <td>
                      <span class="described-by-tooltip"
                            aria-describedby="email-tooltip-{{ forloop.counter }}">{{ log.created_by.email }}</span>
                      <span class="fr-tooltip fr-placement"
                            role="tooltip"
                            id="email-tooltip-{{ forloop.counter }}">{{ log.created_by.email }}</span>
                    </td>
                    <td>
                      {% if log.previous_log %}
                        {{ log.previous_log.get_stage_display }}
                        {% if log.previous_log.decision != "unset" %}
                          <br />
                          {{ log.previous_log.get_decision_display }}
                        {% endif %}
                      {% else %}
                        {{ log|choice_default_label:"stage" }}
                      {% endif %}
                    </td>
                    <td>
                      {{ log.get_stage_display }}
                      {% if log.decision != "unset" %}
                        <br />
                        {{ log.get_decision_display }}
                      {% endif %}
                    </td>
                    <td>
                      <span class="described-by-tooltip"
                            aria-describedby="comment-tooltip-{{ forloop.counter }}">{{ log.update_comment }}</span>
                      <span class="fr-tooltip fr-placement"
                            role="tooltip"
                            id="comment-tooltip-{{ forloop.counter }}">{{ log.update_comment }}</span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>
      {% if page_obj.paginator.num_pages > 1 %}
        <div class="fr-table__footer">
          <div class="fr-table__footer--middle fr-mt-0">{% include "_pagination.html" with page_obj=page_obj %}</div>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_body %}
  {{ block.super }}
  {% include 'haie/petitions/_procedure_modal.html' %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script defer src="{% static 'js/libs/sync_new_due_date.js' %}"></script>

  {% if resume_processing_form and petition_project.current_status.original_due_date %}
    <script>
    window.addEventListener("load", function() {
      let receipt_date_input = document.getElementById("id_info_receipt_date");
      let due_date_input = document.getElementById("id_new_due_date");
      // due date input exists only if a due date was previously set
      if(due_date_input) {
        new DueDateInput(due_date_input, receipt_date_input);
      }
    });
    </script>
  {% endif %}

  <script>
    window.addEventListener('load', function () {
      const displayStageObjective = (stage) => {
        document.querySelectorAll(".stage-objective").forEach(div => div.style.display = "none");
        document.getElementById(`stage-objective--${stage}`).style.display = "block";
      };

      const toggleDueDate = (stage) => {
        if(stage === "closed") {
          document.getElementById("form-group-due_date").style.display = "none";
          document.getElementById("id_due_date").value = "";
        }
        else {
          document.getElementById("form-group-due_date").style.display = "block";
        }
      };

      document.getElementById("id_stage").addEventListener("change", function (event) {
        displayStageObjective(event.target.value);
        toggleDueDate(event.target.value);
      });
      displayStageObjective(document.getElementById("id_stage").value);
      toggleDueDate(document.getElementById("id_stage").value);

    });
  </script>
{% endblock %}
