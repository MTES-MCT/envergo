{% extends 'haie/moulinette/result.html' %}

{% load evaluations static moulinette %}

{% block result %}

  <section class="debug">

    <h1>Paramètres de la moulinette</h1>

    <h2>Données initiales</h2>

    <ul class="fr-mb-2w">
      <li>
        Longueur à détruire : {{ haies.length_to_remove|floatformat:"g" }} m
        <ul>
          {% for h in haies.hedges_to_remove %}
            <li>{{ h.id }} : {{ h.length|floatformat:"g" }} m ⋅ {{ h.hedge_type }}</li>
          {% endfor %}
        </ul>
      </li>
      <li>
        Longueur à planter : {{ haies.length_to_plant|floatformat:"g" }} m
        <ul>
          {% for h in haies.hedges_to_plant %}
            <li>{{ h.id }} : {{ h.length|floatformat:"g" }} m ⋅ {{ h.hedge_type }}</li>
          {% endfor %}
        </ul>
      </li>

      {% if moulinette.config %}
        <li>
          Département : <a href="{% url 'admin:moulinette_configamenagement_change' moulinette.config.pk %}">{{ moulinette.department }}</a>
        </li>
      {% else %}
        <li>Département : {{ moulinette.department }}</li>
      {% endif %}
    </ul>

    <h2>Conditions d'acceptabilité</h2>

    <ul class="fr-mb-2w">
      {% for condition in plantation_evaluation.conditions %}
        <li>
          {{ condition.label }} : {{ condition.result|yesno:"Remplie,Non remplie" }}
          {% if condition.debug_context %}
            <br />
            (
            {% for k, v in condition.debug_context.items %}
              {{ k }} = {{ v }}
              {% if not forloop.last %},{% endif %}
            {% endfor %}
            )
          {% endif %}
        </li>
      {% endfor %}
    </ul>

    <h2>Réglementations</h2>

    {% for regulation in moulinette.regulations %}
      <h3>{{ regulation.title }}</h3>
      <p>
        {% result_tag regulation.result regulation.result_tag_style %}
        <small>({{ regulation.result }})</small>
      </p>

      {% with criteria=regulation.criteria.all %}
        {% if criteria %}
          <ul>
            {% for criterion in criteria %}
              <li class="fr-mb-2w">
                {{ criterion.backend_title }} : {% result_tag criterion.result criterion.result_tag_style %}
                <small>({{ criterion.result_code }})</small>
                {% if criterion.get_evaluator.plantation_conditions %}
                  <br />
                  R = {{ criterion.get_evaluator.get_replantation_coefficient }}
                  <br />
                  Conditions d'acceptabilité =
                  {% for condition in criterion.get_evaluator.plantation_conditions %}
                    {{ condition.label }}
                    {% if not forloop.last %},&nbsp;{% endif %}
                  {% endfor %}
                {% else %}
                  <br />
                  R = ND
                  <br />
                  Conditions d'acceptabilité = aucune
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
    {% endfor %}

    <h2>Catalogue de données</h2>

    <dd>
      {% for key, value in moulinette.catalog.items %}
        <dt>{{ key }}</dt>
        <dd>
          {{ value|truncatechars:150 }}
        </dd>
      {% endfor %}
    </dd>
  </section>
{% endblock %}
