{% load utils %}

<h2 id="moulinette-title" class="centered">Commencez à décrire votre projet de travaux sur haies</h2>

<div id="moulinette-grid">
  <div id="moulinette-col" class="fr-col">
    <div id="moulinette" class="moulinette">
      {% include 'haie/moulinette/_form_introduction.html' %}
      <p class="fr-text--light">Tous les champs sont obligatoires.</p>
      <form class="fr-mb-3w"
            method="post"
            novalidate
            autocomplete="off"
            action="{% url 'moulinette_home' %}?{{ request.GET.urlencode }}"
            id="moulinette-form">
        {% csrf_token %}

        {% include '_form_header.html' with form=form %}

        <!-- Include current query parameters as hidden fields to keep Triage inputs -->
        <input type="hidden"
               name="department"
               value="{{ request.GET.department|default:'' }}" />
        <input type="hidden"
               name="element"
               value="{{ request.GET.element|default:'' }}" />
        <input type="hidden"
               name="travaux"
               value="{{ request.GET.travaux|default:'' }}" />

        <div class="form-section">
          {% include '_radio_snippet.html' with field=form.profil %}
          {% include '_radio_snippet.html' with field=form.motif %}
          {% include '_radio_snippet.html' with field=form.reimplantation %}

          <div class="hedges-input ">
            <div class="fr-table fr-table--sm">
              <div class="fr-table__wrapper">
                <div class="fr-table__container">
                  <div class="fr-table__content">
                    <table>
                      <caption>Localisation des haies</caption>
                      <thead>
                        <tr>
                          <th></th>
                          <th scope="col">Nombre de tracés</th>
                          <th scope="col">Total linéaires (m)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <th>Haies à arracher</th>
                          <td>0</td>
                          <td>0</td>
                        </tr>
                        <tr>
                          <th>Haies à planter</th>
                          <td>0</td>
                          <td>0</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <button id="hedge-input-open-btn"
                    class="fr-btn fr-btn--primary"
                    type="button"
                    data-fr-opened="false"
                    aria-controls="hedge-input-modal">Ouvrir le module de saisie</button>
          </div>

          {% include 'haie/moulinette/_form_footer.html' %}
        </form>

      </div>
    </div>

    {% include 'haie/moulinette/_form_footer.html' %}
  </form>

  {% include 'haie/moulinette/_hedge_input_modal.html' %}

  <script>
  window.addEventListener("load", function() {
    let btn = document.getElementById("hedge-input-open-btn");
    let modal = document.getElementById("hedge-input-modal");
    let hedgeIframe;

    btn.addEventListener("click", function() {
      hedgeIframe = window.open("{% url 'input_hedges' %}", "hedge-input-iframe");
      modal.showModal();
    });

    window.addEventListener("message", function(event) {
      if (event.origin !== window.location.origin) {
        return;
      }

      if (event.data.hedgeData) {
        hedgeIframe.close();
        modal.close();
      }
    });


  });
  </script>
