{% extends "admin/change_form.html" %}

{% block object-tools-items %}
  {% if original.request %}
    <li>
      <a href="{% url 'admin:evaluations_request_change' original.request.id %}">Aller à la demande</a>
    </li>
  {% endif %}
  <li>
    <a href="{{ original.get_absolute_url }}?preview"
       target="_blank"
       rel="noopener">Prévisualiser</a>
  </li>
  <li>
    <a href="{% url 'admin:evaluations_evaluation_publish' original.pk %}">Publier</a>
  </li>
  <li>
    <a href="{{ absolute_url }}"
       class="viewsitelink"
       target="_blank"
       rel="noopener">Voir l'avis publié</a>
  </li>
  {% if original.can_send_regulatory_reminder %}
    <li>
      <a href="{% url 'admin:evaluations_evaluation_email_avis' original.pk %}"
         class="">✉️ Envoyer e-mail avis</a>
    </li>
  {% endif %}
{% endblock %}

{% block admin_change_form_document_ready %}
  {{ block.super }}
  <script>

    // Let's prevent users to leave form before it's saved
    let form = document.getElementById("evaluation_form");
    let formUpdated = false;
    form.addEventListener("change", function () {
      formUpdated = true;
    });

    // We only want to block external links, not form submission
    form.addEventListener("submit", function () {
      formUpdated = false;
    });

    window.addEventListener("beforeunload", function (event) {
      // If the form was updated, display the default browser "are you sure?" message
      if (formUpdated) {
        event.preventDefault();
        event.returnValue = "";
        return "";
      }
    });
  </script>
{% endblock %}
