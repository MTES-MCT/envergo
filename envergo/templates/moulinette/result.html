{% extends 'moulinette/base.html' %}

{% load evaluations static l10n %}

{% block html-classes %}full-height{% endblock %}
{% block body-classes %}full-height flex-body{% endblock %}
{% block main-classes %}full-height flex-body{% endblock %}

{% block container %}
  <div id="moulinette-result-container" class="full-height fr-container">
    <div class="fr-grid-row">
      <div id="project-summary" class="fr-col-4 fr-py-4w fr-px-2w">
        <h2 class="fr-mb-5w">Le projet</h2>
        <p class="fr-text print-only">
          Simulation réalisée sur <a title="EnvErgo : la réglementation environnementale pour les projets de construction et d'aménagement"
    href="{{ envergo_url }}"
    target="_blank"
    rel="noopener external">EnvErgo</a>
        </p>
        <p class="fr-text print-only">
          Cette simulation est <a title="Partager l'avis réglementaire"
    href="{{ current_url }}"
    target="_blank"
    rel="noopener external">consultable en ligne</a>
        </p>

        {{ form.lng.as_hidden }}
        {{ form.lat.as_hidden }}
        <figure class="fr-content-media">
          <div id="map-container" class="ratio-4x3 fr-mt-1w fr-mb-2w fr-raw-link">
            <div class="ratio-content">
              <div class="leaflet-container">
                <div id="map">
                  <a id="map-button"
                     href="{% url 'moulinette_home' %}?{{ request.GET.urlencode }}"
                     class="fr-btn fr-btn--secondary fr-mt-3w fr-btn--icon-left fr-icon-arrow-left-line">Modifier le
                    projet
                  </a>
                </div>
              </div>
            </div>
          </div>
        </figure>
        {% include 'evaluations/_specifications.html' with params=moulinette.raw_data address=address coords=coords %}
        <div class="button-container">
          <a href="{% url 'moulinette_home' %}?{{ request.GET.urlencode }}"
             class="fr-btn fr-btn--secondary fr-mt-3w fr-btn--icon-left fr-icon-arrow-left-line">Modifier le projet</a>
        </div>
      </div>
      <div id="project-result" class="fr-col-8">
        <section class="fr-py-4w fr-pl-6w fr-pr-2w">
          {% if config and not config.is_activated %}
            <div class="fr-alert fr-alert--info fr-alert--small fr-mb-3w">
              Le simulateur n'est pas activé dans ce département ({{ moulinette.department.department }}). Vous voyez
              cette page grâce à votre statut d'admin.
            </div>
          {% endif %}
          <h1 class="fr-mb-5w">Simulation réglementaire</h1>

          <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--icon-left fr-btns-group--center hide-print">
            <li>
              <button class="js fr-btn fr-btn--tertiary fr-btn--icon-left fr-icon-mail-fill share-btn"
                      data-fr-opened="false"
                      aria-controls="share-modal"
                      data-btn="bottom">Partager cette page par email</button>
            </li>
            <li>
              <button class="js fr-btn fr-btn--tertiary fr-btn--icon-left fr-icon-file-download-fill share-btn"
                      onclick="window.print();">Imprimer cette simulation</button>
            </li>
          </ul>

          <h2 class="fr-h3">Réglementations environnementales</h2>

          {% include 'moulinette/_evaluation_summary.html' %}

          <p class="fr-hint-text fr-mb-3w">
            Cette simulation est établie à titre informatif. Elle ne vaut pas position de l'administration. <a href="#liability-info" class="hide-print">En savoir plus.</a>
          </p>

          {% for regulation in moulinette.regulations %}
            {% include 'moulinette/_result_regulation.html' with regulation=regulation %}

          {% endfor %}

          {% include 'moulinette/_additional_regulations.html' with moulinette=moulinette %}

          <div id="liability-info" class="fr-alert fr-alert--info fr-my-5w">
            <p>
              EnvErgo est un service du Ministère de la Transition Écologique. Il vise à aider les acteurs de
              l'aménagement en phase amont de leurs projets.
            </p>
            <p>
              Les simulations sont établies à titre informatif, et ne valent pas position de l'administration. Elles ne
              couvrent pas l'exhaustivité des réglementations ni la spécificité de certains projets.
            </p>
            <p>
              Les porteurs doivent échanger directement avec les autorités administratives compétentes (collectivité en
              charge de l'urbanisme, DDT(M), DREAL…) pour obtenir une position officielle.
            </p>
          </div>

          <section class="regulation regulation-disabled fr-mb-5w"
                   id="regulation_defrichement">
            <h2>
              <span class="content">Défrichement</span> {% result_tag 'non_disponible' %}
            </h2>
            <p>
              Cette réglementation sera prochainement prise en compte dans EnvErgo.
              Vous pouvez <a target="_blank" rel="noopener" href="https://tally.so/r/w4QrEO">voter pour la demander en
              priorité</a>.
            </p>
          </section>
        </section>

        {% include "_learn_more.html" %}
        <section class="fr-footer  fr-pb-2w" role="contentinfo">
          {% include '_footer.html' %}
        </section>
      </div>
    </div>
  </div>
{% endblock %}

{% block after-content %}{% endblock %}
{% block footer %}<div id="action-banner" class="fr-py-4w"></div>{% endblock %}

{% block extra_js %}
  {#  {{ block.super }}#}
  <script>
    var DEPARTMENT = "{{ moulinette.department.department }}";
    window.MAPS = window.MAPS || {};
    window.MAPS['map'] = {
      center: {coordinates: [{{ center_map.0|unlocalize }}, {{ center_map.1|unlocalize }}]},
      entries: [],
      caption: null,
      truncate: true,
      zoom: 17,
      ratio: "4x3",
      fixed: false
    };
  </script>

  <script defer src="{% static 'leaflet/dist/leaflet.js' %}"></script>
  <script defer src="{% static 'leaflet/draw/leaflet.draw.js' %}"></script>
  <script defer src="{% static 'js/libs/moulinette_result_maps.js' %}"></script>
  <script defer src="{% static 'js/libs/moulinette_analytics.js' %}"></script>
  {#  <script defer src="{% static 'js/libs/share_url_modal.js' %}"></script>#}
{% endblock %}
