{% extends 'moulinette/base_result.html' %}
{% load evaluations static moulinette %}


{% block result %}

  <section class="debug">
    <h1>Paramètres de la moulinette</h1>

    <h2>Données initiales</h2>

    <ul>
      <li>Surface existante: {{ existing_surface }} m²</li>
      <li>Surface créée: {{ created_surface }} m²</li>
    </ul>

    <h2>Critères pris en compte</h2>

    <ul>
      {% for criterion in moulinette.criterions %}
        <li>{{ criterion.title }} ({{ criterion.slug }})</li>
      {% endfor %}
    </ul>

    <h2>Résultat</h2>

    {% for regulation in moulinette.regulations %}
      <h3>{{ regulation.title }} : {% result_tag regulation.result %}</h3>

      <ul>
        {% for criterion in regulation.criterions %}
          <li>{{ criterion.title }} : {% result_tag criterion.result %}</li>
        {% endfor %}
      </ul>
    {% endfor %}


    <h2>Détails du calcul</h2>

    <ul>
      <li>Coordonnées du projet : {{ coords }}</li>
      <li>Département : {{ department }}</li>
      <li>Infos de contact département : {{ department.contact_md|yesno:'Oui,Non' }} </li>
      <li>Présence de zones humides à 25m du projet : {{ wetlands_25|yesno:"Oui,Non" }}</li>
      <li>Présence de zones humides à 100m du projet : {{ wetlands_100|yesno:"Oui,Non" }}</li>
      <li>Présence de zones humides potentielles (« doute ») : {{ within_potential_wetlands|yesno:"Oui,Non" }}</li>
      <li>Présence de zones inondables à 12m du projet : {{ flood_zones_12|yesno:"Oui,Non" }}</li>
    </ul>

    <div class="ratio-1x1 fr-mt-1w fr-mb-2w">
      <div class="ratio-content">
        <div class="leaflet-container">
          <div id="debug-map"></div>
        </div>
      </div>
    </div>
  </section>

{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    window.addEventListener('load', function() {

      var map = L.map('debug-map', {maxZoom: 21});
      var coordsStyles = {'color': 'orange', 'fillColor': 'orange'};
      var wetlandsStyles = {'color': 'none', 'fillColor': 'green'};
      var potentialWetlandsStyles = {'color': 'none', 'fillColor': 'orange'};
      var floodZonesStyles = {'color': 'none', 'fillColor': 'red'};
      var circle12Styles = {'color': 'yellow', 'fillColor': 'yellow'};
      var circle25Styles = {'color': 'yellow', 'fillColor': 'yellow'};
      var circle100Styles = {'color': 'yellow', 'fillColor': 'yellow'};

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 22,
        maxNativeZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
      }).addTo(map);

      var coords = JSON.parse('{% to_geojson coords %}');
      var coordsGeoJSON = L.geoJSON(coords, {style: coordsStyles});
      coordsGeoJSON.addTo(map);

      {% if wetlands_100 %}
        var wetlands = JSON.parse('{% to_geojson wetlands_100 %}');
        var wetlandsGeoJSON = L.geoJSON(wetlands, {style: wetlandsStyles});
        wetlandsGeoJSON.addTo(map);
      {% endif %}

      {% if potential_wetlands %}
        var potentialWetlands = JSON.parse('{% to_geojson potential_wetlands %}');
        var potentialWetlandsGeoJSON = L.geoJSON(potentialWetlands, {style: potentialWetlandsStyles});
        potentialWetlandsGeoJSON.addTo(map);
      {% endif %}

      {% if flood_zones_12 %}
        var floodZones = JSON.parse('{% to_geojson flood_zones_12 %}');
        var floodZonesGeoJSON = L.geoJSON(floodZones, {style: floodZonesStyles});
        floodZonesGeoJSON.addTo(map);
      {% endif %}

      var circle12 = JSON.parse('{% to_geojson circle_12 %}');
      var circle12GeoJSON = L.geoJSON(circle12, {style: circle12Styles});
      circle12GeoJSON.addTo(map);

      var circle25 = JSON.parse('{% to_geojson circle_25 %}');
      var circle25GeoJSON = L.geoJSON(circle25, {style: circle25Styles});
      circle25GeoJSON.addTo(map);

      var circle100 = JSON.parse('{% to_geojson circle_100 %}');
      var circle100GeoJSON = L.geoJSON(circle100, {style: circle100Styles});
      circle100GeoJSON.addTo(map);

      map.fitBounds(circle100GeoJSON.getBounds(), {padding: [50, 50]});

      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML += '<span><i style="background: green"></i> Zones humides</span>';
        div.innerHTML += '<span><i style="background: orange"></i> ZH (doute)</span>';
        div.innerHTML += '<span><i style="background: red"></i> Zones inondables</span>';
        return div;
      };
      legend.addTo(map);
    });
  </script>
{% endblock %}
