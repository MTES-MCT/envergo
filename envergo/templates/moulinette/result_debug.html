{% extends 'moulinette/base_result.html' %}
{% load evaluations static moulinette %}


{% block result %}

  <section class="debug">
    <h1>Paramètres de la moulinette</h1>

    <h2>Données initiales</h2>

    <ul>
      <li>Surface existante: {{ existing_surface }} m²</li>
      <li>Surface créée: {{ created_surface }} m²</li>
      <li>Surface finale: {{ final_surface }} m²</li>
    </ul>

    <h2>Périmètres et critères activés</h2>

    {% regroup moulinette.perimeters by map as map_list %}
    {% for map in map_list %}
      <h3>{{ map.grouper }}</h3>

      <div class="ratio-1x1 fr-mt-1w fr-mb-3w">
        <div class="ratio-content">
          <div class="leaflet-container">
            <div id="perimeter-map-{{ forloop.counter0 }}"></div>
          </div>
        </div>
      </div>

      <dl class="fr-mb-5w">
        <dt>Distance :</dt>
        <dd>{{ map.list.0.distance }}</dd>

        <dt>Critères :</dt>
        <dd>
          <ul>
            {% for perimeter in map.list %}
              <li><strong>{{ perimeter.criterion.title }} ({{ perimeter.criterion.slug }})</strong>
            {% endfor %}
          </ul>
        </dd>
      </dl>
    {% endfor %}

    <h2>Polygones</h2>

    {% for zone in all_zones %}
      <h3>{{ zone.map.display_name|default:zone.map.name }}</h3>

      <div class="ratio-1x1 fr-mt-1w fr-mb-3w">
        <div class="ratio-content">
          <div class="leaflet-container">
            <div id="zone-map-{{ forloop.counter0 }}"></div>
          </div>
        </div>
      </div>

      <dl class="fr-mb-5w">
        <dt>Distance :</dt>
        <dd>{{ zone.distance }}</dd>
        <dt>Carte :</dt>
        <dd>{{ zone.map }}</dd>
        <dt>Type de carte :</dt>
        <dd>{{ zone.map.get_data_type_display }} ({{ zone.map.get_data_certainty_display }})</dd>
      </dl>
    {% endfor %}


    <h2>Résultat</h2>

    {% for regulation in moulinette.regulations %}
      <h3>{{ regulation.title }} : {% result_tag regulation.result %}</h3>

      <ul>
        {% for criterion in regulation.criterions %}
          <li>{{ criterion.title }} : {% result_tag criterion.result %}</li>
        {% endfor %}
      </ul>
    {% endfor %}

    <h2>Catalogue de données</h2>

    <dd>
      {% for key, value in moulinette.catalog.items %}
        <dt>{{ key }}</dt>
        <dd>{{ value|truncatechars:150 }}</dd>
      {% endfor %}
    </dd>

{% endblock %}

{% block extra_js %}
  {{ block.super }}

  {% regroup moulinette.perimeters by map as map_list %}
  {% for map in map_list %}
    <script>
      window.addEventListener('load', function() {

        var map = L.map('perimeter-map-{{ forloop.counter0 }}', {maxZoom: 21});
        var coordsStyles = {'color': 'orange', 'fillColor': 'orange'};
        var polygonStyles = {'color': 'none', 'fillColor': 'blue'};

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 22,
          maxNativeZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
        }).addTo(map);

        var coords = JSON.parse('{% to_geojson coords %}');
        var coordsGeoJSON = L.geoJSON(coords, {style: coordsStyles});
        coordsGeoJSON.addTo(map);

        var polygon = JSON.parse('{% to_geojson map.list.0.geometry %}');
        var polygonGeoJSON = L.geoJSON(polygon, {style: polygonStyles});
        polygonGeoJSON.addTo(map);

        map.fitBounds(polygonGeoJSON.getBounds(), {padding: [30, 30]});
      });
    </script>
  {% endfor %}

  {% for zone in all_zones %}
    <script>
      window.addEventListener('load', function() {

        var map = L.map('zone-map-{{ forloop.counter0 }}', {maxZoom: 21});
        var coordsStyles = {'color': 'orange', 'fillColor': 'orange'};
        var polygonStyles = {'color': 'none', 'fillColor': 'blue'};

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 22,
          maxNativeZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
        }).addTo(map);

        var coords = JSON.parse('{% to_geojson coords %}');
        var coordsGeoJSON = L.geoJSON(coords, {style: coordsStyles});
        coordsGeoJSON.addTo(map);

        var polygon = JSON.parse('{% to_geojson zone.geom %}');
        var polygonGeoJSON = L.geoJSON(polygon, {style: polygonStyles});
        polygonGeoJSON.addTo(map);

        map.fitBounds(polygonGeoJSON.getBounds(), {padding: [30, 30]});
      });
    </script>
  {% endfor %}

{% endblock %}
