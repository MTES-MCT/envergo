{% extends 'base.html' %}
{% load evaluations leaflet_tags %}

{% block title %}Consultez l'évaluation pour votre projet{% endblock %}

{% block breadcrumbs %}
<nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d'Ariane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="/">Accueil</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'evaluation_search' %}">Évaluations</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" aria-current="page">Demandez une évaluation</a>
      </li>
    </ol>
  </div>
</nav>
{% endblock %}

{% block article %}
<h1>Demandez une évaluation de votre projet</h1>

<p class="fr-text--lead">
  EnvErgo peut vous aider à déterminer si votre projet d'urbanisme
  est soumis à la Loi sur l'eau. Recevez une réponse dans les deux jours ouvrés.
</p>

<form action="" method="post" id="request-evaluation-form" novalidate>
  {% csrf_token %}

  {% include '_form_header.html' with form=form %}

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2"> Localisation de votre projet </legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Elle est essentielle pour connaître les règles locales relatives à la Loi sur l'eau.</p>
    </div>

    {% include '_field_snippet.html' with field=form.address %}

    <label class="fr-label fr-mb-3w">Renseignez une ou plusieurs parcelles cadastrales concernées par
      votre projet.</label>

    {% include 'geodata/_parcel_formset.html' with formset=parcel_formset %}

    <div role="alert" class="fr-my-3w fr-alert fr-alert--info">
      <p>Vous pouvez utiliser la carte embarquée pour trouver les identifiants de vos parcelles.</p>
    </div>

    <div class="ratio-4x3">
      <div class="ratio-content">
        {% leaflet_map 'cadastre_map' callback="window.map_init" %}
      </div>
    </div>
  </fieldset>

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2">Caractéristiques du projet</legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Ces paramètres nous permettront de réaliser l'évaluation.</p>
    </div>

    {% include '_field_snippet.html' with field=form.application_number %}

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-md-6">
        {% include '_field_snippet.html' with field=form.existing_surface %}
      </div>
      <div class="fr-col-12 fr-col-md-6">
        {% include '_field_snippet.html' with field=form.created_surface %}
      </div>
    </div>
  </fieldset>

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2">Vos informations de contact</legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Nous enverrons l'évaluation à ces coordonnées.</p>
    </div>

    {% include '_field_snippet.html' with field=form.contact_email %}
    {% include '_field_snippet.html' with field=form.phone_number %}
  </fieldset>


  <button type="submit" class="fr-mt-6w fr-mb-3w fr-btn fr-fi-checkbox-circle-line fr-btn--icon-left">
    Envoyez votre demande évaluation
  </button>

  <div role="alert" class="fr-alert fr-alert--info">
    <p>En validant votre formulaire, vous acceptez que vos données soient traitées <a href="{% url 'legal_mentions' %}"
        target="_blank" rel="noopener">en accord avec notre politique de
        traitement des données</a>.</p>
  </div>

</form>

{% endblock %}

{% block extra_css %}
{% leaflet_css %}
{% endblock %}

{% block extra_js %}
{% leaflet_js %}
<script>
  function map_init(map, options) {
    //var lc = L.control.layers().addTo(map);

    // An example from the Atlas of Living Australia https://www.ala.org.au/
    var layer = L.tileLayer(
      "https://wxs.ign.fr/parcellaire/geoportail/wms?" +
      "&REQUEST=GetTile" +
      "&SERVICE=WMS" +
      "&VERSION=1.3.0" +
      "&STYLE=PCI vecteur" +
      "&TILEMATRIXSET=PM" +
      "&FORMAT=image/png" +
      "&LAYER=CADASTRALPARCELS.PARCELLAIRE_EXPRESS" +
      "&TILEMATRIX={z}" +
      "&TILEROW={y}" +
      "&TILECOL={x}", {
        minZoom: 0,
        maxZoom: 18,
        attribution: "IGN-F/Geoportail",
        tileSize: 256 // les tuiles du Géooportail font 256x256px
      }
    );
    layer.addTo(map);
  }

</script>
{% endblock %}
