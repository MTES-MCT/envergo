{% extends 'base.html' %}
{% load evaluations leaflet_tags static %}

{% block title %}Consultez l'évaluation pour votre projet{% endblock %}

{% block breadcrumbs %}
<nav role="navigation" class="fr-breadcrumb" aria-label="vous êtes ici :">
  <button class="fr-breadcrumb__button" aria-expanded="false" aria-controls="breadcrumb-1">Voir le fil d'Ariane</button>
  <div class="fr-collapse" id="breadcrumb-1">
    <ol class="fr-breadcrumb__list">
      <li>
        <a class="fr-breadcrumb__link" href="/">Accueil</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" href="{% url 'evaluation_search' %}">Évaluations</a>
      </li>
      <li>
        <a class="fr-breadcrumb__link" aria-current="page">Demandez une évaluation</a>
      </li>
    </ol>
  </div>
</nav>
{% endblock %}

{% block article %}
<h1>Demandez une évaluation de votre projet</h1>

<p class="fr-text--lead">
  EnvErgo vous aide à déterminer si votre projet d'urbanisme
  est soumis à la Loi sur l'eau. Recevez une réponse dans les deux jours ouvrés.
</p>

<div id="autocomplete_address_input"></div>

<form action="" autocomplete="off" method="post" id="request-evaluation-form" novalidate>
  {% csrf_token %}

  {% include '_form_header.html' with form=form %}

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2"> Localisation de votre projet </legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Elle est essentielle pour connaître les règles locales relatives à la Loi sur l'eau.</p>
    </div>

    {% include '_field_snippet.html' with field=form.address %}

    <label class="fr-label fr-mb-3w">
      Renseignez la ou les parcelles cadastrales concernées par votre projet.
      Vous pouvez utiliser <a href="https://cadastre.data.gouv.fr/map?style=vector" target="_blank" rel="noopener">cette
        carte cadastrale pour trouver les identifiants de vos parcelles</a>.</label>

    {% include 'geodata/_parcel_formset.html' with formset=parcel_formset %}

    <button type="button" id="btn-add-parcel" class="fr-btn fr-mt-3w">
      Ajouter une parcelle
    </button>

  </fieldset>

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2">Caractéristiques du projet</legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Ces paramètres nous permettront de réaliser l'évaluation.</p>
    </div>

    {% include '_field_snippet.html' with field=form.created_surface %}

    <div class="fr-grid-row fr-grid-row--gutters">
      <div class="fr-col-12 fr-col-md-6">
        {% include '_field_snippet.html' with field=form.existing_surface %}
      </div>
      <div class="fr-col-12 fr-col-md-6">
        {% include '_field_snippet.html' with field=form.application_number %}
      </div>
    </div>
  </fieldset>

  <fieldset class="fr-mb-6w">
    <legend class="fr-h2">Vos informations de contact</legend>

    <div role="alert" class="fr-mb-3w fr-alert fr-alert--info">
      <p>Nous enverrons l'évaluation à ces coordonnées.</p>
    </div>

    {% include '_field_snippet.html' with field=form.contact_email %}
    {% include '_field_snippet.html' with field=form.phone_number %}
  </fieldset>

  <button type="submit" class="fr-mt-6w fr-mb-3w fr-btn fr-fi-checkbox-circle-line fr-btn--icon-left">
    Envoyer votre demande d'évaluation
  </button>

  <div role="alert" class="fr-alert fr-alert--info">
    <p>En validant votre formulaire, vous acceptez que vos données soient traitées <a href="{% url 'legal_mentions' %}" target="_blank" rel="noopener">en accord avec notre politique de
        traitement des données</a>.</p>
  </div>

</form>

<template id="tpl-form-parcel" class="form-template">
  {% include 'geodata/_parcel_line_form.html' with form=parcel_formset.empty_form counter='__prefix__' %}
</template>

{% endblock %}

{% block extra_css %}
{% leaflet_css %}
<link rel="stylesheet" href="{% static 'accessible-autocomplete/dist/accessible-autocomplete.min.css' %}" />
</style>

{% endblock %}

{% block extra_js %}
{% leaflet_js %}
<script defer src="{% static 'js/libs/parcel_fieldset.js' %}"></script>
<script defer src="{% static 'accessible-autocomplete/dist/accessible-autocomplete.min.js' %}"></script>

<script>
  window.addEventListener('load', function() {
    function debouncePromise(fn, time) {
      let timerId = undefined;

      return function debounced(...args) {
        if (timerId) {
          clearTimeout(timerId);
        }

        return new Promise((resolve) => {
          timerId = setTimeout(() => resolve(fn(...args)), time);
        });
      };
    }

    const debouncedFetch = debouncePromise(fetch, 150);
    const autocompleteContainer = document.getElementById('autocomplete_address_input');

    accessibleAutocomplete({
      element: autocompleteContainer,
      id: '#autocomplete_address_input',
      minLength: 3,
      templates: {
        inputValue: function(item) {
          const value = item ? item.properties.label : '';
          return value;
        },
        suggestion: function(item) {
          return `<div>
            <strong>${item.properties.label}</strong> <br />
            <span>${item.properties.context}</span>
          </div>`;
        }
      },
      tNoResults: () => 'Aucun résultat trouvé',
      tStatusQueryTooShort: (minQueryLength) => `Saisissez au moins ${minQueryLength} caractères pour voir des résultats`,
      tStatusNoResults: () => 'Aucun résultat de recherche',
      tStatusSelectedOption: (selectedOption, length, index) => `${selectedOption} ${index + 1} de ${length} est en surbrillance`,
      tStatusResults: function(length, contentSelectedOption) {
        let result;
        if (length === 1) {
          result = `<span>1 résultat disponible. ${contentSelectedOption}</span>`;
        } else {
          result = `<span>${length} résultats disponibles. ${contentSelectedOption}</span>`;
        }
        return result;
      },
      tAssistiveHint: function() {
        return "Quand des résultats d'autocomplétion sont disponibles, utilisez " +
          "les flèches haut et bas pour les parcourir. Utilisez entrée pour " +
          "sélectionner. Sur périphérique tactile, explorez en glissant le doigt.";
      },
      onConfirm: function(val) {
        console.log(val);
      },
      source: function(query, populateResults) {
        return fetch(`https://api-adresse.data.gouv.fr/search/?type=housenumber&autocomplete=1&q=${query}`)
          .then((response) => response.json())
          .then(({ features }) => {
            const results = features.map((f) => f.properties.label);
            populateResults(features);
          })
          .catch(() => []);
      }
    });
  });
</script>
{% endblock %}
