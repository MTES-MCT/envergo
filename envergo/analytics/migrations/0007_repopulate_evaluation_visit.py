# Generated by Django 4.2.23 on 2025-12-11 09:16

from django.db import migrations
from tqdm import tqdm

from envergo.moulinette.utils import MoulinetteUrl
from envergo.moulinette.models import MoulinetteAmenagement


def repopulate_evaluation_visit(apps, schema_editor):
    Event = apps.get_model("analytics", "Event")
    qs = Event.objects.filter(
        category="evaluation", event="visit", date_created__gte="2025-10-27T00:00:00Z"
    ).exclude(metadata__has_key="main_result")
    total = qs.count()
    batch_size = 10
    i = 0
    with tqdm(total=total) as pbar:
        while i < total:
            models = qs[i : i + batch_size].iterator()  # noqa
            to_update = []
            for event in models:

                reference = event.metadata.get("request_reference")
                if reference is None:
                    continue

                evaluation = (
                    apps.get_model("evaluations", "Evaluation")
                    .objects.filter(reference=reference)
                    .first()
                )
                if evaluation is None:
                    continue

                data = MoulinetteUrl(evaluation.moulinette_url).params
                moulinette_data = {"initial": data, "data": data}
                moulinette = MoulinetteAmenagement(moulinette_data)
                if moulinette is None:
                    continue

                if moulinette.is_evaluation_available():
                    event.metadata["result"] = moulinette.result_data()
                    event.metadata["main_result"] = moulinette.result
                    to_update.append(event)

            Event.objects.bulk_update(to_update, ["metadata"])
            i += batch_size
            pbar.update(batch_size)


class Migration(migrations.Migration):

    dependencies = [
        ("analytics", "0006_cspreport"),
    ]

    operations = [
        migrations.RunPython(repopulate_evaluation_visit, migrations.RunPython.noop),
    ]
