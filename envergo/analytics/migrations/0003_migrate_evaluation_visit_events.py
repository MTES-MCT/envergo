# Generated by Django 3.2.16 on 2023-02-17 14:28

from django.db import migrations
from urllib.parse import urlparse
from django.http import QueryDict


def params_from_url(url):
    """Extract query string from url and return a dict."""

    url = urlparse(url)
    params = QueryDict(url.query)
    return params.dict()

def migrate_events(apps, schema_editor):
    Event = apps.get_model("analytics", "Event")
    events = Event.objects.filter(category="evaluation", event="visit").filter(metadata__lat__isnull=True).filter(metadata__reference__isnull=False)

    Evaluation = apps.get_model("evaluations", "Evaluation")

    for event in events:
        reference = event.metadata['reference']
        evaluation = Evaluation.objects.get(reference=reference)
        if evaluation.moulinette_url:
            params = params_from_url(evaluation.moulinette_url)
            event.metadata.update(params)
            event.save()


class Migration(migrations.Migration):

    dependencies = [
        ('analytics', '0002_migrate_formsubmit_metadata'),
    ]

    operations = [
        migrations.RunPython(migrate_events, migrations.RunPython.noop),
    ]
